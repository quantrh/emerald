<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FIS Emerald 2025 Conference Agenda</title>
  <style>
    /* Styles omitted for brevity; assume unchanged */
  </style>
</head>
<body>
  <header>
    <h1>FIS Emerald 2025 Conference Agenda (May 19–21)</h1>
  </header>
  <div class="controls">
    <!-- View Mode and Filters unchanged -->
  </div>
  <div id="event-counter"></div>
  <div id="agenda"></div>
  <button class="scroll-top" id="scroll-top">↑ Top</button>

  <script>
    let eventsData = [];
    const agenda = document.getElementById('agenda');
    const viewMode = document.getElementById('view-mode');
    const dayFilter = document.getElementById('filter-day');
    const periodFilter = document.getElementById('filter-period');
    const rangeFilter = document.getElementById('filter-range');
    const idFilterInput = document.getElementById('id-filter');
    const idFilterBtn = document.getElementById('filter-id-btn');
    const searchInput = document.getElementById('search');
    const counter = document.getElementById('event-counter');
    const scrollBtn = document.getElementById('scroll-top');

    async function loadEvents() {
      try {
        const res = await fetch('events.json');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        eventsData = await res.json();
        eventsData.forEach(e => {
          // Normalize missing space before time
          e.time = e.time.replace(/(\D)(?=(\d{1,2}:))/g, '$1 ');
          // Extract range substring
          const r = e.time.match(/\d{1,2}:\d{2}\s?(?:AM|PM)\s?-\s?\d{1,2}:\d{2}\s?(?:AM|PM)\s?EDT/);
          e.range = r ? r[0] : '';
          // Extract full date label "Day, Month Day"
          const d = e.time.match(/^([A-Za-z]+,\s*[A-Za-z]+\s*\d{1,2})/);
          e.dateLabel = d ? d[1] : e.day;
          // Day-only label for filtering
          e.day = e.dateLabel.split(',')[0];
          // Period
          const st = e.range.match(/(\d{1,2}):(\d{2})\s?(AM|PM)/);
          let hr = st ? parseInt(st[1], 10) : 0;
          if (st && st[3] === 'PM' && hr < 12) hr += 12;
          if (st && st[3] === 'AM' && hr === 12) hr = 0;
          e.period = hr < 12 ? 'Morning' : hr < 17 ? 'Afternoon' : 'Evening';
        });
        render();
      } catch (err) {
        console.error('Failed to load events:', err);
        counter.textContent = 'Unable to load events. Please check JSON file name.';
      }
    }

    function render() {
      agenda.innerHTML = '';
      let filtered = eventsData
        .filter(e => dayFilter.value === 'All' || e.day === dayFilter.value)
        .filter(e => periodFilter.value === 'All' || e.period === periodFilter.value);
      if (rangeFilter.value !== 'All') filtered = filtered.filter(e => e.range === rangeFilter.value);
      const ids = idFilterInput.value.split(',').map(s => s.trim()).filter(Boolean);
      if (ids.length) filtered = filtered.filter(e => ids.includes(e.id));
      const txt = searchInput.value.trim().toLowerCase();
      if (txt) filtered = filtered.filter(e => (`${e.title} ${e.rawDesc}`).toLowerCase().includes(txt));

      const groupings = {};
      if (viewMode.value === 'byDate') {
        filtered.forEach(e => {
          groupings[e.dateLabel] = groupings[e.dateLabel] || [];
          groupings[e.dateLabel].push(e);
        });
      } else {
        filtered.forEach(e => {
          const key = `${e.range} – ${e.dateLabel}`;
          groupings[key] = groupings[key] || [];
          groupings[key].push(e);
        });
      }

      Object.entries(groupings).forEach(([label, evs]) => {
        const section = document.createElement('div');
        section.className = viewMode.value === 'byDate' ? 'day-section' : 'time-section';
        const header = document.createElement('div');
        header.className = viewMode.value === 'byDate' ? 'day-header' : 'time-header';
        header.textContent = label;
        section.appendChild(header);

        const container = document.createElement('div');
        if (viewMode.value === 'byTime') container.className = 'cards-container';
        evs.forEach(e => renderCard(e, container));
        section.appendChild(container);
        agenda.appendChild(section);
      });

      counter.textContent = `${filtered.length} events found`;
    }

    function renderCard(e, parent) {
      const card = document.createElement('div');
      card.className = 'event-card';
      card.innerHTML = `
        <p class="title">${e.title}</p>
        <div class="times">${e.range}</div>
        <div class="description"><p>${e.rawDesc}</p></div>
        <div class="location">Location: ${e.location || ''}</div>
        <button class="add-calendar" onclick="addToCalendar('${e.id}')">Add to Calendar</button>
      `;
      parent.appendChild(card);
    }

    // addToCalendar and event listeners remain unchanged
    loadEvents();
  </script>
</body>
</html>
